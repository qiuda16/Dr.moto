# DrMoto 微信小程序重构计划 (MVP-车主端)

根据您提供的详细需求分析，我们将抛弃之前的“特斯拉仿真玩具”路线，转而开发一个**真正落地的、业务闭环的售后服务小程序**。

## 核心目标
构建一个 **稳定、可商用** 的车主端小程序，实现从“报修 -> 报价 -> 支付 -> 交付”的全流程闭环。

## Phase 1: 基础设施重构 (Foundation)
**目标**: 建立符合微信生态和业务稳定性的底层架构。

1.  **前端工程化 (`clients/mp_customer`)**:
    *   **技术栈**: 保持 Vue3 + Vant (H5 模式，通过 WebView 或作为 PWA 运行，方便快速迭代)。*注：如果需原生小程序代码，需另开工程，考虑到当前环境，建议先完善 H5 版作为原型，逻辑通了再迁移原生。*
    *   **网络层封装**: 实现统一的 `request.js`，包含：
        *   Token 自动注入与刷新 (401处理)。
        *   `X-Trace-Id` 链路追踪。
        *   **幂等性机制**: 对 POST 请求自动生成 `Idempotency-Key`。
    *   **状态管理**: 使用 Pinia 管理 User, ActiveOrder, Notification 状态。

2.  **BFF 接口对齐 (`bff`)**:
    *   **认证**: 升级 `/auth/login` 支持模拟微信登录 (Code -> JWT)。
    *   **工单**: 完善 `/mp/workorders` 系列接口，支持状态机流转。
    *   **支付**: 实现 `/mp/payments/create_intent` (模拟微信支付回调)。

## Phase 2: 核心业务闭环 (The Core Loop)
**目标**: 打通您提到的 **流程1 (报修)** 和 **流程3 (支付)**。

1.  **首页 (Home) 重构**:
    *   **快速入口**: “一键报修”、“救援”、“保养”。
    *   **进行中卡片**: 首页顶部醒目展示当前工单状态（如“待确认报价”）。
    *   **AI 助手入口**: 悬浮球或底部 Tab，支持文本/语音输入故障描述。

2.  **报修流程 (Create Work Order)**:
    *   **车辆选择**: 从 Odoo 拉取车辆档案。
    *   **多媒体上传**: 实现分片上传或队列上传机制（模拟），确保弱网下图片不丢。
    *   **幂等提交**: 确保手抖不会创建两张工单。

3.  **工单详情与支付 (Detail & Pay)**:
    *   **时间轴 (Timeline)**: 清晰展示工单生命周期（接单 -> 报价 -> 施工 -> 完工）。
    *   **报价单 (Quote)**: 展示零件明细、工时费、总价。
    *   **支付动作**: 集成模拟支付，支付成功后自动触发工单状态变更。

## Phase 3: AI 与 消息 (Intelligence)**
**目标**: 提升用户体验和转化率。

1.  **AI 问诊**:
    *   接入 LLM，根据用户描述生成初步诊断建议，并推荐维修项目。
2.  **消息中心**:
    *   模拟微信“服务通知”，在 App 内展示关键节点通知。

---

### 立即执行计划 (Next Step)
我将优先执行 **Phase 1 & 2**，将当前的小程序改造成一个**标准的售后服务工具**。

1.  **重写前端路由与布局**: 移除“特斯拉”风格，换回清晰的业务导向 UI。
2.  **封装网络层**: 确保请求可靠性。
3.  **实现标准报修流程**: 选车 -> 描述 -> 上传 -> 提交。

*确认后，我将立即开始重构代码。*
