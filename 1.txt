0. 全局架构与边界（先定规矩，后做功能）
0.1 角色与端划分

顾客端（WeChat 小程序）：提交需求、授权车辆、查看进度、确认报价、支付、评价。

技师端（WeChat 小程序 / Pad Web）：接单、诊断、工时/备件录入、过程留痕（图/视频）、节点更新。

展示端（店内大屏 / 排队屏）：不登录或弱登录，只展示“叫号、进度、预计完成”。

管理端（店长/前台/财务/仓库）：排程、报价审批、退换/反冲、库存操作（最终落 Odoo）、对账。

BFF：唯一对外入口（统一鉴权、限流、幂等、审计、聚合 Odoo/AI/存储）。
GitHub

Odoo：库存、产品、出入库、成本、票据等“真值系统”。
GitHub

0.2 事件驱动（保证稳定与可观测）

建议把“工单状态变化、支付回调、出入库过账”都变成领域事件（写库 → Outbox → 异步分发），避免端到端强耦合导致雪崩。

1. 顾客端（车主小程序）设计
1.1 MVP 功能闭环（必须先跑通）

登录/绑定：微信静默登录 + 手机号（可选）

车辆：添加车辆（VIN/车架号/车型年款/里程）、绑定常用门店

工单：创建工单（故障描述 + 图片/视频 + 预约）

进度：工单时间线（已提交→已接单→诊断→报价→维修中→待支付→已完成）

报价确认：展示报价明细（工时、配件、优惠、税费）+ 版本号

支付：微信支付（预支付单）+ 结果页 + 发票信息（后置）

评价：星级 + 标签 + 文本

1.2 页面信息架构（推荐 TabBar 4 个）

首页：进行中工单卡片 + “一键报修”

工单：列表（进行中/历史）+ 筛选

消息：系统通知（报价/待支付/完工）

我的：车辆、门店、个人信息、设置

1.3 稳定性关键点（小程序端）

弱网与断点续传：上传必须队列化；失败可重试；不要 base64 直传大文件。

幂等键：创建工单、确认报价、支付发起都要客户端生成 Idempotency-Key（UUID）。

报价版本：quote_version 不一致时禁止支付，提示“报价已更新请重新确认”。

2. 技师端（技师小程序 / Pad）设计
2.1 核心工作台（技师每天只做这几件事）

待接单：按门店/工位/技能标签过滤

进行中：我的工单、计时器（工时）与节点按钮

诊断记录：故障码/检修结论/建议项目（支持模板化）

过程留痕：拍照/短视频/语音转文字（用于争议与质检）

备件领用申请：选择配件（来源 Odoo 产品）+ 数量 + 关联工单

完工确认：自检 checklist（刹车/灯光/漏油/试车）

2.2 权限与风控

技师端只能更新工单过程字段，不能直接改金额与库存真值。

领用只是“申请/预占”，最终由仓库/前台在 Odoo 过账（或由系统在审批后调 Odoo 过账）。
GitHub

2.3 关键状态机（建议）

SUBMITTED（顾客提交）

ACCEPTED（前台/技师接单）

DIAGNOSING

QUOTED

CUSTOMER_CONFIRMED

REPAIRING

READY_TO_PAY

PAID

CLOSED / CANCELED

3. 展示端（店内大屏/排队屏）设计
3.1 展示内容（避免敏感信息）

叫号：取号/工单短号（脱敏）+ 当前状态 + 工位

预计完成：区间（例如 30–60 分钟），避免精确承诺

门店公告：营业时间、注意事项

3.2 技术实现

Web 单页（大屏适配），BFF 提供只读接口

缓存策略：30–60 秒刷新；BFF 做汇总与脱敏

安全：仅允许门店内网访问或通过门店设备 token

4. 管理端（店长/前台/财务/仓库）设计
4.1 店长/前台

排程：工位/技师负载、预约冲突提示

报价审核：高额项目需二次确认（阈值规则）

结算：对账/退款/补差价（都要留审计）

4.2 仓库

领用出库：从“申请单”生成 Odoo 出库单/拣货单并过账（库存真值始终在 Odoo）。
GitHub

退料入库：维修未用完配件退回（反向过账）

盘点：周期盘点与差异原因

4.3 财务

支付流水：微信回调原文、签名校验结果、幂等处理记录（不可变账本）

发票：后置开票与状态同步

5. BFF / API 层（系统“稳定性中枢”）
5.1 你应该把 BFF 做成的样子

BFF 不只是“转发”，它要承担：

鉴权（微信登录态/JWT/门店设备 token）

限流与熔断（保护 Odoo 与 AI）

幂等（对外写接口必须幂等）
GitHub

审计（谁在何时做了什么）
GitHub

聚合（把 Odoo 分散的对象聚合成端侧需要的 DTO）

5.2 接口分域（建议）

/mp/*：顾客端

/tech/*：技师端

/admin/*：管理端

/display/*：展示端（只读脱敏）

/webhooks/wechatpay/*：支付回调（仅回调入口）

5.3 幂等与审计的落库形态（建议）

idempotency_keys：(key, route, request_hash, response_body, status, created_at)

audit_log：追加写（who/when/what/before/after/trace_id）

payment_events：追加写（回调原文、验签结果、处理状态）

6. Odoo 端（库存/产品/过账真值）

你的仓库已经明确“库存真值在 Odoo、所有库存变化通过 Odoo 过账事务”。
GitHub

因此设计要点是：

6.1 Odoo 承担的对象

产品（配件 SKU、价格、成本、供应商）

库存（门店仓、在途、可用量）

出入库单（领用出库、退料入库）

（可选）销售单/发票/客户

6.2 BFF 与 Odoo 的“防腐层”

只通过一套封装好的 Odoo Adapter 调用 Odoo（REST/XML-RPC 均可）

任何 Odoo 异常都不能直接透传给端侧，要转换为稳定错误码体系

7. AI 端（客服/知识库/智能质检）
7.1 你真正需要的 AI 能力（分层）

P0：知识库问答 + 工单辅助填写（RAG：车型常见故障、保养周期、门店规则）

P1：技师诊断辅助（基于故障码/现象/历史维修记录给建议）

P2：过程质检（检查是否缺少关键照片、是否跳过 checklist）

7.2 AI 的安全边界

AI 不允许“直接写 Odoo/DB”。AI 只能调用 BFF 提供的受控工具接口（带权限与审计）。

AI 输出必须可追溯：引用的知识片段、版本号、时间戳。

8. Edge / IoT 端（摄像头/工位设备/传感器）
8.1 设备模型（最小可用）

设备注册：device_id / store_id / type / status / last_seen

事件上报：device_events（温度/门磁/工位占用/抓拍）

媒体流：推荐只做“上报截图/片段”，视频流走成熟方案（RTSP/NVR），BFF 只存索引

8.2 与工单关联

关键事件与工单绑定：例如“工位开始/结束”“工具归位异常”“拍照留痕”

9. 数据库与存储端（你问的“数据库端”重点）
9.1 数据真值分层（必须坚持）

Odoo Postgres：库存/产品/过账真值（不要绕开）
GitHub

BFF 自己的 Postgres：用户、车辆、工单聚合视图、支付账本、审计、媒体元数据、设备、事件流

9.2 建议的 BFF 核心表（最小集）

users（openid/unionid/手机号/门店偏好）

vehicles（车主-车辆关系、车型年款、里程）

work_orders（状态机、门店、技师、关联 odoo 单据 id）

work_order_timeline（追加写：状态变化、备注、操作人）

quotes（报价版本、明细 JSON、确认状态）

payments（intent、金额、状态、关联工单）

payment_events（微信回调原文、验签、幂等处理结果）——不可变

media_objects（对象存储 key、hash、大小、关联工单）

audit_log（全域审计）
GitHub

9.3 对“大数据不崩”的具体措施

分区：audit_log / payment_events / device_events 按月分区

索引：work_orders(store_id, status, updated_at)、payments(order_id, status)

冷热分离：媒体只存对象存储，DB 只存元数据

读写隔离：后期可加只读副本（先不强上）

10. Analytics / 报表端（运营与 KPI）
10.1 你应该统计什么（优先级）

工单漏斗：提交→接单→报价→确认→完工→支付

时效：接单时长、诊断时长、维修时长、等待支付时长

人效：技师工时、返工率、客户评分

库存：缺件率、周转天数（来源 Odoo）

10.2 数据路径

BFF 侧事件（timeline/payment/audit）→ 轻量数仓（先用 Postgres 物化视图即可）→ 管理端报表